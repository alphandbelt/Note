### Install libguestfs 

* 在ubuntu中需要安装的依赖

sudo apt install erlang-guestfs gir1.2-guestfs-1.0 golang-guestfs-dev guestfsd libguestfs-dev libguestfs-gfs2 libguestfs-gobject-1.0-0 libguestfs-gobject-dev libguestfs-hfsplus libguestfs-java libguestfs-jfs libguestfs-nilfs libguestfs-ocaml libguestfs-ocaml-dev libguestfs-perl libguestfs-reiserfs libguestfs-rescue libguestfs-rsync libguestfs-nilfs libguestfs-ocaml libguestfs-ocaml-dev libguestfs-perl libguestfs-reiserfs libguestfs-rescue libguestfs-rsync libguestfs-tools libguestfs-xfs libguestfs-zfs libguestfs0 lua-guestfs php-guestfs python-guestfs python3-guestfs ruby-guestfs gperf flex bison po4a xz-utils libjansson-dev libhivex-dev libmagic-dev libconfig-dev libxml2-dev libagues-dev libhivex-ocaml libhivex-ocaml-dev

* 卸载之前安装的所有默认的openjdk

* 重新安装一个openjdk8

  > sudo apt-get install openjdk-8-jdk

* erlang 1.23

* ubuntu18 install erlang 1.23

  * wget -O- https://packages.erlang-solutions.com/ubuntu/erlang_solutions.asc | sudo apt-key add -

  * echo "deb https://packages.erlang-solutions.com/ubuntu bionic contrib" | sudo tee /etc/apt/sources.list.d/rabbitmq.list

  * sudo apt update && sudo apt install erlang

  * ```bash
    sudo update-alternatives --set java /usr/lib/jvm/java-1.8.0-openjdk-amd64/bin/java
    ```
  
* ubuntu java 没有javac 

  * sudo apt install default-jre 
  * sudo apt install default-jdk

### 在redhat 版本 >= 7.2不支持挂载NTFS

### centos install libmagic没有 ，使用yum install file-devel

### targetcli

* target 是目标端，在target 上进行要分享设备的设置
  * 启动服务
    * systemctl start target 
    * systemctl enable target （开启启动）
  * 添加一个设备
    * cd /backstores/fileio/
    * create disk0 /tmp/disk0.img 10MB
    * cd /backstores/ramdisk/
    * create rd0 10MB
  * 创建target
    * cd /iscsicd 
    * create   （创建完之后portal自动创建）
  * 设置 ACL
    * cd /iscsi/iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.46377ffefd36/tpg1/acls/
    * create iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.46377ffefd36
  * 设置TPG
    * 0.0.0.0：3260
  * 开启端口
    * firewall-cmd --add-port 3260/tcp --permanent && firewall-cmd 
  * 添加（添加的设备）到tpg
    * cd /iscsi/iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.46377ffefd36/tpg1/luns/
    * create /backstores/fileio/disk0
    * create /backstores/ramdisk/rd0
  * 保存配置
    * cd /
    * saveconfig

#### initiator

* 查看自己的 IQN
* cat /etc/iscsi/initiatorname.iscsi

* initator是用户端，在这个上面发现target上分享的设备
  * 添加发现
    * iscsiadm -m discovery -t sendtargets -p 192.168.50.145:3260
    
  * 登录
    * iscsiadm --mode node --targetname iqn.2003-01.org.linux-iscsi.localhost.x8664:sn.46377ffefd36 --portal 192.168.50.145 --login
    
  * lsblk 发现
    * ![image-20201225152751579](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20201225152751579.png)
    
  * 登出
  
    * 两个 任选其一
  
    * ```shell
      iscsiadm --mode node --target <IQN> --portal x.x.x.x --logout
      iscsiadm --mode node --logoutall=all
      ```

### tmux 开启鼠标滚动

* setw -g mode-mouse on

### 安装mariadb 到windows

* 下载地址
  * https://mariadb.com/downloads/
* 文档
  * https://mariadb.com/kb/en/installing-mariadb-msi-packages-on-windows/

### 运行nats-streaming-server 

* nats-streaming-server -store sql -sql_driver mysql -sql_source "nss:password@/nss_db?readTimeout=5s&writeTimeout=5s" 

* mysql 创建表
  * https://github.com/nats-io/nats-streaming-server/blob/master/scripts/mysql.db.sql
  * 运行命令
    * mysql -u nss -p -D nss_db -e "$(cat ./scripts/mysql.db.sql)"
* mysql 创建数据库
  * mysql -u root -e "CREATE USER 'nss'@'localhost' IDENTIFIED BY 'password'; GRANT ALL PRIVILEGES ON *.* TO 'nss'@'localhost'; CREATE DATABASE nss_db;"

#### Nats Streaming 

* nats streaming的client和服务端交互的时候不直接交互，而是通过nats server来进行
* nats client和nats streaming客户端彼此之间消息不互通
* 如果服务端没有收到心跳包（配置的数量），服务端就会主动关闭连接

* nats streaming的这个还可以使用Grafana 或者Prometheus的监控前端页面展示。



## centos 卸载Mariadb安装 MySQL

* 下载rpm包 https://dev.mysql.com/downloads/repo/yum/ 

* 执行命令卸载Mariadb 

  * rpm -qa | grep Maria*
  * yum -y remove Maria*
  * rm -rf /var/lib/mysql

* 安装

  * 参考链接 https://dev.mysql.com/doc/refman/5.7/en/linux-installation-yum-repo.html
  * rpm包下载地址 https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm
  * sudo yum localinstall mysql80-community-release-el7-3.noarch.rpm
  * 关闭默认的MYSQL的模块
    * sudo yum module disable mysql
  * 安装 MYSQL
    * sudo yum install mysql-community-server
  * 启动mysql服务
    * sudo service mysqld start
  * 查看服务
    * sudo service mysqld status
  * 查看默认密码
    * sudo grep 'temporary password' /var/log/mysqld.log
  * 登录并且修改密码
    * mysql -uroot -p
    * ALTER USER 'root'@'localhost' IDENTIFIED BY 'MyNewPass4!';
  
  ###  删除lv时出现被占用的情况
  
   * 执行脚本找出与该lvm相关的进程
  
      * ```shell
        for i in  /proc/[0-9]* ; do echo $i >> /tmp/mountinfo ;  grep -q "/dev/mapper/test-vg-test-storage" $i/mountinfo ; echo $? >> /tmp/mountinfo ; done
        
        # for i in  /proc/[0-9]* ; do echo $i >> /tmp/mountinfo ;  grep -q "/dev/mapper/test-vg-test-storage" $i/mountinfo ; echo $? >> /tmp/mountinfo ; done
        
        for i in  /proc/[0-9]* ; do echo $i >> /tmp/mountinfo ;  grep -q "/dev/mapper/vg--docker-lvapp" $i/mountinfo ; echo $? >> /tmp/mountinfo ; done
        
        ```
  
   * 查看
  
      * ```shell
        grep -B 1 '^0$' /tmp/mountinfo
        ```

## Mysql修改数据目录

* https://blog.csdn.net/ruanhao1203/article/details/52242438

### 精简配置

* 精简配置（Thin Provisioning）指分配的资源量超过实际的物理量，类似于现实社会中的“超售”概念。
* LVM的精简配置有两个重要的概念，分别是精简池和精简卷

### 精简池

* 精简池是一个特殊的LV,在它建立时会立即从VG中分配空间，与正常的LV没有什么不同。但是这个LV不能被创建文件系统直接使用，而是处于一种特殊的格式，包含数据和元数据两个部分。
* 精简池的作用是为精简卷提供空间，而精简卷本身不能从VG中直接获取空间。

#### 精简卷

* 精简卷和普通卷的根本差异，在于其创建时，并不从VG中真正的分配空间，而是虚拟的分配空间，当进行写入时，则会写入到对应的精简池中。



## There are no enabled repo

* curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

  

## Mount disk to local

```python

#/usr/bin/python
import guestfs
g = guestfs.GuestFS(python_return_dict=True)
# You can specify the right file name.
disk = "disk.img"
g.add_drive_opts(disk, format="qcow2")
g.launch()
 
# You specify your rules to choose the right partition to mount.
partitions = g.list_partitions ()
assert (len (partitions) == 1)
 
# Here we are assuming that this is the right partition
g.mount (partitions[0], "/")
g.mount_local("/mnt/", options="allow_other", readonly=True)
g.mount_local_run()
```



```python
import guestfs
        os.environ["LIBGUESTFS_BACKEND"] = "direct"
        g = guestfs.GuestFS(python_return_dict=True)
        g.add_drive_opts(disk, readonly=1)
        g.launch()
        # g.list_filesystems()
        # g.list_partitions()

        g.inspect_os()
        g.inspect_os()
        g.inspect_get_roots()
        g.list_partitions()
        g.list_devices()
        g.inspect_get_filesystems()
        g.blkid()
        g.lvs_full()
        g.vgs_full()
        g.vgscan()
        g.lvm_canonical_lv_name()
        g.inspect_get_mountpoints()
        g.list_dm_devices()
        g.df()
        g.df_h()
        g.get_direct()
        g.__dir__()
        g.nr_devices()
        g.initrd_list()

        # Ask libguestfs to inspect for operating systems.

        roots = g.list_partitions()
        if len(roots) == 0:
            print("0\nno filesystem,exit")
            exit(1)
        # print(roots)
        res = {}
        res["partitions"] = roots
        print(json.dumps(res, indent=2, ensure_ascii=True))
```





## libguestfs 挂载windows

* **https://libguestfs.org/guestfs-faq.1.html#mount:-unsupported-filesystem-type-with-ntfs-in-rhel-7.2**

* In RHEL 7.2 we were able to add `libguestfs-winsupport` to the base RHEL distribution, but we had to disable the ability to use it for opening and editing filesystems. It is only supported when used with [virt-v2v(1)](https://libguestfs.org/virt-v2v.1.html). If you try to use [guestfish(1)](https://libguestfs.org/guestfish.1.html) or [guestmount(1)](https://libguestfs.org/guestmount.1.html) or some other programs on an NTFS filesystem, you will see the error:

* ```
   mount: unsupported filesystem type
  ```

* This is not a supported configuration, and it will not be made to work in RHEL. Don't bother to open a bug about it, as it will be immediately `CLOSED -> WONTFIX`.

* You may [compile your own libguestfs removing this restriction](https://www.redhat.com/archives/libguestfs/2016-February/msg00145.html), but that won't be endorsed or supported by Red Hat.

* 

![image-20210719164111140](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210719164111140.png)

## 编译

* yum install gperf flex bison pcre2-devel augeas augeas-devel file-devel jansson-devel hivex hivex-devel supermin ocaml ocaml-findlib-devel ocaml-hivex-devel
*  yum install autoconf automake libtool gettext-devel
* 修改默认的supermin
  * rm  /bin/supermin
  * ln /bin/supermin5 /bin/supermin
* 



## centos7 安装libguestfs-winsupport（不起作用，需要编译源码）

* https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/
  * https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/libguestfs-winsupport-7.2-3.el7.x86_64.rpm

* https://documentation.solusvm.com/display/BET/Libguestfs+for+CentOS+7

  * RHEL disabled NTFS (windows) support in it's CentOS 7 libguestfs packages. We've rebuilt these packages to enable it again.

    Disable the libguestfs package from the main CentOS base repo:

    ``` bash 
    vi /etc/yum.repos.d/CentOS-Base.repo
    ```

  * Add **exclude=libguestfs\* perl-Sys-Guestfs\*** to each stanza like the example below:

    ```bash
    # CentOS-Base.repo
    #
    # The mirror system uses the connecting IP address of the client and the
    # update status of each mirror to pick mirrors that are updated to and
    # geographically close to the client.  You should use this for CentOS updates
    # unless you are manually picking other mirrors.
    #
    # If the mirrorlist= does not work for you, as a fall back you can try the
    # remarked out baseurl= line instead.
    #
    #
     
    [base]
    name=CentOS-$releasever - Base
    mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=os&infra=$infra
    #baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    exclude=libguestfs* perl-Sys-Guestfs*
     
    #released updates
    [updates]
    name=CentOS-$releasever - Updates
    mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=updates&infra=$infra
    #baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    exclude=libguestfs* perl-Sys-Guestfs*
     
    #additional packages that may be useful
    [extras]
    name=CentOS-$releasever - Extras
    mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=extras&infra=$infra
    #baseurl=http://mirror.centos.org/centos/$releasever/extras/$basearch/
    gpgcheck=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    exclude=libguestfs* perl-Sys-Guestfs*
     
    #additional packages that extend functionality of existing packages
    [centosplus]
    name=CentOS-$releasever - Plus
    mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=centosplus&infra=$infra
    #baseurl=http://mirror.centos.org/centos/$releasever/centosplus/$basearch/
    gpgcheck=1
    enabled=0
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    exclude=libguestfs* perl-Sys-Guestfs*
    ```

  * Download our custom libguestfs repo:

    ```bash 
    wget http://libguestfs.solusvm.com/centos/libguestfs-plesk.repo -O /etc/yum.repos.d/libguestfs-plesk.repo
    ```

  * It should look like the one below:

    ```bash
    # cat /etc/yum.repos.d/libguestfs-plesk.repo
    [libguestfs-plesk]
    name=Libguestfs-Plesk
    baseurl=http://libguestfs.solusvm.com/centos/$releasever/$basearch
    enabled=1
    gpgcheck=0
     
    [libguestfs-plesk-noarch]
    name=Libguestfs-Plesk-norarch
    baseurl=http://libguestfs.solusvm.com/centos/$releasever/noarch
    enabled=1
    gpgcheck=0
    ```

  * Install or update to our packages:

    ```bash
    yum remove libguestfs*
    yum install libguestfs*.plesk
    rpm -Uvh --force http://mirror.centos.org/centos/7/os/x86_64/Packages/libguestfs-winsupport-7.2-3.el7.x86_64.rpm
    ```

    

## Incorrect checksum 

*  pvcreate -ff -u  qc07yL-O0L2-Ja3F-7kwt-2yn8-3QmX-lLnqoq --restorefile /etc/lvm/backup/backup_vg /dev/sda3

## libguestfs 重新编译后最小安装

* 使用libguestfs libguestfs-devel  virt-v2v
* 下载链接
  * http://mirror.centos.org/centos/7/os/x86_64/Packages/

![image-20210721135053173](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721135053173.png)

* 添加ndbkit 

  ![image-20210721135631447](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721135631447.png)

* 添加nbdk的插件之后

  ![image-20210721140710603](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721140710603.png)

  ​	

  ![image-20210721140927926](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721140927926.png)

  ![image-20210721141044008](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721141044008.png)

* /dev/sda1

![image-20210721154134195](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721154134195.png)

* /dev/sda2

![image-20210721154217022](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721154217022.png)

* /dev/sda4

![image-20210721154417561](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210721154417561.png)



## 多个虚拟机vmdk合并成一个

```bash
PS D:\Program Files (x86)\VMware\VMware Workstation> .\vmware-vdiskmanager.exe -r D:\alphandbeltWorkspace\download\fenqu_centos\CentOS_7_64_位-disk1.vmdk -t 0 D:\alphandbeltWorkspace\download\fenqu_centos2\centos7.vmdk
Creating disk 'D:\alphandbeltWorkspace\download\fenqu_centos2\centos7.vmdk'
```



## VEEM 

![image-20210722143523768](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722143523768.png)



![image-20210722163238614](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722163238614.png)

![image-20210722170902809](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722170902809.png)

![image-20210722184758371](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722184758371.png)

![image-20210722184823371](C:/Users/win10/AppData/Roaming/Typora/typora-user-images/image-20210722184823371.png)

![image-20210722184843087](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722184843087.png)

![image-20210722194847078](https://raw.githubusercontent.com/alphandbelt/Note/main/img/image-20210722194847078.png)

